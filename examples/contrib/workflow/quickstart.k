// ============================================================================
// QUICK START: Timer Tasks & Sub-DAGs
// ============================================================================
// Minimal examples to get started with the new workflow features
// ============================================================================

let makeEngine = import "examples/contrib/workflow/engine.k"
let WorkflowEngine = makeEngine()

log("================================================================================")
log("QUICK START: Timer Tasks & Sub-DAGs")
log("================================================================================")
log("")

// ============================================================================
// TIMER TASK QUICK START
// ============================================================================

log("Example 1: Simple Timer Task (Delayed Execution)")
log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")

let timerDemo = {
    name: "Welcome Email",
    type: "timer",
    task: {
        name: "Send Welcome",
        delay: 500,
        handler: (ctx) -> {
            log("  üìß Sending welcome email...")
            { success: true, data: "Email sent!" }
        }
    }
}

let result1 = WorkflowEngine.execute(timerDemo, {}, WorkflowEngine.defaultConfig)
log("Status:", if result1.success { "‚úì" } else { "‚úó" })
log("")

// ============================================================================
// INTERVAL TASK QUICK START
// ============================================================================

log("Example 2: Interval Task (Repeated Execution)")
log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")

let intervalDemo = {
    name: "Heartbeat Monitor",
    type: "interval",
    task: {
        name: "Check Status",
        interval: 200,
        maxRepetitions: 3,
        handler: (ctx) -> {
            log("  üíì Heartbeat #", ctx.iteration)
            { success: true, data: { beat: ctx.iteration } }
        }
    }
}

let result2 = WorkflowEngine.execute(intervalDemo, {}, WorkflowEngine.defaultConfig)
log("Status:", if result2.success { "‚úì" } else { "‚úó" })
log("Total iterations:", result2.iterations)
log("")

// ============================================================================
// SUB-DAG QUICK START
// ============================================================================

log("Example 3: Reusable Sub-DAG")
log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")

// Define a reusable validation component
let createValidation = () -> {
    let nodes = [
        {
            id: "check-1",
            name: "Check Format",
            handler: (ctx) -> {
                log("    ‚úì Format check passed")
                { success: true, data: { valid: true } }
            }
        },
        {
            id: "check-2",
            name: "Check Schema",
            handler: (ctx) -> {
                log("    ‚úì Schema check passed")
                { success: true, data: { valid: true } }
            }
        }
    ]
    { nodes: nodes, edges: [] }  // Parallel execution
}

let validation = createValidation()
let validationSubDAG = WorkflowEngine.createSubDAG(
    "validation",
    "Validation Sub-DAG",
    validation.nodes,
    validation.edges
)

// Use the sub-DAG in a workflow
let workflow = {
    name: "Data Pipeline",
    type: "dag-with-subdags",
    nodes: [
        {
            id: "load",
            name: "Load Data",
            handler: (ctx) -> {
                log("  üì• Loading data...")
                { success: true, data: { records: 100 } }
            }
        },
        validationSubDAG,  // <- Reusable component
        {
            id: "save",
            name: "Save Data",
            handler: (ctx) -> {
                log("  üíæ Saving data...")
                { success: true, data: { saved: true } }
            }
        }
    ],
    edges: [
        { source: "load", target: "validation" },
        { source: "validation", target: "save" }
    ]
}

let result3 = WorkflowEngine.execute(workflow, {}, WorkflowEngine.defaultConfig)
log("Status:", if result3.success { "‚úì" } else { "‚úó" })
log("")

// ============================================================================
// COMBINED EXAMPLE
// ============================================================================

log("Example 4: Timer + Sub-DAG Combined")
log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")

// Delayed workflow that uses a sub-DAG
let processingSubDAG = WorkflowEngine.createSubDAG(
    "process",
    "Processing Steps",
    [
        {
            id: "step-1",
            name: "Transform",
            handler: (ctx) -> {
                log("    üîÑ Transforming...")
                { success: true, data: {} }
            }
        },
        {
            id: "step-2",
            name: "Enrich",
            handler: (ctx) -> {
                log("    ‚ûï Enriching...")
                { success: true, data: {} }
            }
        }
    ],
    [{ source: "step-1", target: "step-2" }]
)

// Delayed workflow
let delayedWorkflow = & (() -> {
    log("  ‚è∞ Waiting before processing...")
    sleep(300)
    
    let wf = {
        name: "Delayed Processing",
        type: "dag-with-subdags",
        nodes: [processingSubDAG],
        edges: []
    }
    
    WorkflowEngine.execute(wf, {}, WorkflowEngine.defaultConfig)
})()

let result4 = wait delayedWorkflow
log("Status:", if result4.success { "‚úì" } else { "‚úó" })
log("")

// ============================================================================
// SUMMARY
// ============================================================================

log("================================================================================")
log("‚úì Quick Start Complete!")
log("================================================================================")
log("")
log("You've learned:")
log("  1. Timer tasks - Delayed execution with configurable delays")
log("  2. Interval tasks - Repeated execution at regular intervals")
log("  3. Sub-DAGs - Reusable workflow components")
log("  4. Combining features - Timer + Sub-DAG integration")
log("")
log("Next steps:")
log("  ‚Ä¢ Check timer_tasks.k for advanced timer examples")
log("  ‚Ä¢ Check subdag_demo.k for complex sub-DAG patterns")
log("  ‚Ä¢ Read README.md for complete documentation")
log("")
